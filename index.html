<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore di Calendario SEO con AI Strategica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .gradient-bg { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .plan-enter, .mindmap-enter, .modal-enter { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        [contenteditable]:focus { outline: 2px solid #3b82f6; background-color: #eff6ff; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .prose h2 { font-size: 1.5em; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 600;}
        .prose h3 { font-size: 1.25em; margin-top: 1.25em; margin-bottom: 0.5em; font-weight: 600;}
        .prose p { margin-bottom: 1em; line-height: 1.6;}
    </style>
</head>
<body class="gradient-bg min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8 pt-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Generatore di Calendario Editoriale SEO</h1>
        </header>
        
        <div id="intro" class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl shadow-lg mb-10 text-center">
            <h2 class="text-xl font-bold text-gray-700 mb-2">Dall'Idea alla Pubblicazione, con l'AI.</h2>
            <p class="text-gray-600">Questo strumento ti aiuta a pianificare e a scrivere i contenuti per il tuo sito. Rispondi, personalizza la mappa, espandi con l'AI e infine genera articoli completi pronti per essere pubblicati.</p>
        </div>

        <!-- FASE 1: WIZARD / INPUT -->
        <div id="wizard" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">1. Raccontaci di te</h2>
            <div class="space-y-6">
                <div>
                    <label for="professione" class="block text-sm font-medium text-gray-600 mb-2">Chi sei?</label>
                    <input type="text" id="professione" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Es: Architetto specializzato in bioedilizia">
                </div>
                <div>
                    <label for="citta" class="block text-sm font-medium text-gray-600 mb-2">Dove operi?</label>
                    <input type="text" id="citta" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Es: Firenze">
                </div>
                <div>
                    <label for="servizi" class="block text-sm font-medium text-gray-600 mb-2">Servizi principali</label>
                    <input type="text" id="servizi" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Es: Ristrutturazione appartamenti, Direzione lavori...">
                    <p class="text-xs text-gray-500 mt-1">Elenca i tuoi servizi principali, separati da una virgola.</p>
                </div>
                <div>
                    <label for="domanda_frequente" class="block text-sm font-medium text-gray-600 mb-2">Domanda frequente dei clienti</label>
                    <input type="text" id="domanda_frequente" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Es: Quanto costa ristrutturare casa a Roma?">
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="generateMapBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 flex items-center justify-center mx-auto">
                    Crea Mappa Mentale
                </button>
            </div>
        </div>
        
        <!-- FASE 2: MAPPA MENTALE EDITABILE -->
        <div id="mindMap" class="hidden mt-12 mindmap-enter">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">2. Personalizza la tua Mappa Strategica</h2>
            <p class="text-gray-600 mb-6 text-center">Clicca sul testo per modificarlo. Usa l'AI per trovare nuove idee.</p>
            <div id="mindMapContainer" class="p-4 md:p-6 bg-white/70 rounded-2xl shadow-lg"></div>
            <div class="text-center mt-8 space-y-4 md:space-y-0 md:space-x-4">
                <button id="generateCalendarBtn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">
                    Genera Calendario Finale
                </button>
                 <button id="resetBtn" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600">
                    Ricomincia
                </button>
            </div>
        </div>

        <!-- FASE 3: PIANO DETTAGLIATO (TABELLA) -->
        <div id="detailedPlan" class="hidden mt-12 plan-enter">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">3. Il Tuo Piano Editoriale</h2>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Settimana</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Idea di Titolo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keyword</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azione</th>
                        </tr>
                    </thead>
                    <tbody id="planTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modale Messaggi Generici -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-sm w-full text-center">
            <h3 id="modalTitle" class="text-xl font-bold text-yellow-500 mb-4">Ooops!</h3>
            <div id="modalMessage" class="text-gray-700 mb-6 space-y-2"></div>
            <button id="closeModalBtn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600">Ho capito</button>
        </div>
    </div>

    <!-- Modale Editor Articolo -->
    <div id="articleModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50 modal-enter">
        <div class="bg-gray-50 rounded-2xl shadow-2xl max-w-3xl w-full h-full max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="articleModalTitle" class="text-lg font-bold text-gray-800"></h3>
                <button id="closeArticleModalBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="articleModalContent" class="p-6 overflow-y-auto flex-grow prose max-w-none">
                <!-- Contenuto Articolo generato da JS -->
            </div>
            <div class="p-4 border-t bg-white rounded-b-2xl">
                <button id="copyArticleBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">Copia Articolo</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const wizardDiv = document.getElementById('wizard');
        const generateMapBtn = document.getElementById('generateMapBtn');
        const mindMapDiv = document.getElementById('mindMap');
        const mindMapContainer = document.getElementById('mindMapContainer');
        const generateCalendarBtn = document.getElementById('generateCalendarBtn');
        const detailedPlanDiv = document.getElementById('detailedPlan');
        const planTableBody = document.getElementById('planTableBody');
        const resetBtn = document.getElementById('resetBtn');
        const professioneInput = document.getElementById('professione');
        const serviziInput = document.getElementById('servizi');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const articleModal = document.getElementById('articleModal');
        const articleModalTitle = document.getElementById('articleModalTitle');
        const articleModalContent = document.getElementById('articleModalContent');
        const closeArticleModalBtn = document.getElementById('closeArticleModalBtn');
        const copyArticleBtn = document.getElementById('copyArticleBtn');

        let mindMapData = {};
        let userProfile = {};
        let allContentForCalendar = [];

        const capitalizeFirstLetter = (string) => string ? string.charAt(0).toUpperCase() + string.slice(1) : '';
        const showModal = (title, message, isError = true) => {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modalTitle.className = isError ? 'text-xl font-bold text-red-600 mb-4' : 'text-xl font-bold text-yellow-500 mb-4';
            messageModal.classList.remove('hidden');
        };
        const friendlyErrorMessage = `<p>Ci state sfondando l'A.I.!!</p><p class="mt-2">Troppe persone stanno usando il generatore, causando ritardi.</p><p class="mt-4">Attendi un istante e riprova.</p><p class="mt-4 text-xs italic">P.S. Grazie perché ci stai usando!</p>`;

        function renderMindMap() {
            mindMapContainer.innerHTML = '';
            const { landing, pillar, clusters } = mindMapData;
            let mapHtml = `<div class="flex flex-col items-center space-y-4">`;
            mapHtml += createNodeHtml('landing', 0, landing);
            mapHtml += `<div class="h-8 w-px bg-gray-400"></div>`;
            mapHtml += createNodeHtml('pillar', 0, pillar);
            if (clusters.length > 0) {
                mapHtml += `<div class="h-8 w-px bg-gray-400"></div><div class="flex flex-wrap justify-center gap-4" id="cluster-container">`;
                clusters.forEach((cluster, index) => mapHtml += createNodeHtml('clusters', index, cluster, true));
                mapHtml += `</div>`;
            }
            mapHtml += `<div class="mt-6"><button data-action="expand-ai" class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 py-2 px-4 rounded-full font-semibold flex items-center gap-2">✨ Amplia con AI</button></div></div>`;
            mindMapContainer.innerHTML = mapHtml;
        }

        function createNodeHtml(type, index, data, isCluster = false) {
            let bgColor = data.tipo === 'Suggerito da AI' ? 'bg-purple-50' : (isCluster ? 'bg-green-50' : (type === 'landing' ? 'bg-red-50' : (type === 'pillar' ? 'bg-blue-50' : 'bg-white')));
            return `<div class="p-4 rounded-lg shadow-md ${bgColor} w-full md:w-auto md:max-w-md text-center"><div class="flex items-center justify-center"><p contenteditable="true" data-action="edit-title" data-type="${type}" data-index="${index}" class="font-bold text-gray-800 p-1">${data.titolo}</p>${type !== 'landing' ? `<button data-action="delete" data-type="${type}" data-index="${index}" class="ml-2 text-red-400 hover:text-red-600 text-xl font-bold">&times;</button>` : ''}</div><p class="text-xs text-gray-500 mt-1"><code>${data.keyword}</code></p></div>`;
        }
        
        generateMapBtn.addEventListener('click', async () => {
            const professione = professioneInput.value.trim();
            const serviziText = serviziInput.value.trim();
            const servizi = serviziText ? serviziText.split(',').map(s => s.trim()) : [];
            const citta = document.getElementById('citta').value.trim();
            const domanda_frequente = document.getElementById('domanda_frequente').value.trim();

            if (!professione || !citta || servizi.length === 0 || !domanda_frequente) {
                showModal('Attenzione!', 'Assicurati di compilare tutti i campi.');
                return;
            }
            
            generateMapBtn.innerHTML = `<div class="loader"></div>`; generateMapBtn.disabled = true;

            try {
                const optimizePrompt = `Analizza la domanda di un utente "${domanda_frequente}" per un professionista che opera a "${citta}". Normalizza la domanda in un titolo SEO efficace per un articolo di blog, assicurandoti che la città sia presente una sola volta in modo naturale. Estrai anche la keyword principale (long-tail). Rispondi solo con un oggetto JSON con le chiavi "titolo" e "keyword".`;
                const optimizeResponse = await fetch(`/.netlify/functions/optimize-question`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: optimizePrompt }) });
                if (!optimizeResponse.ok) throw new Error('Errore ottimizzazione domanda.');
                const optimizedQuestion = await optimizeResponse.json();

                userProfile = { professione, servizi, citta };
                const cittaC = capitalizeFirstLetter(citta);
                const s1 = servizi[0]; const s2 = servizi[1];

                mindMapData = {
                    landing: { titolo: `${capitalizeFirstLetter(professione)} a ${cittaC}`, keyword: `${professione.toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Landing Page Locale', sinossi: `Pagina di vendita principale.` },
                    pillar: { titolo: `Guida a ${capitalizeFirstLetter(s1)} a ${cittaC}`, keyword: `guida ${s1.toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Contenuto Pillar', sinossi: `Articolo completo sul servizio principale.` },
                    clusters: [
                        { titolo: optimizedQuestion.titolo, keyword: optimizedQuestion.keyword, tipo: 'Domanda Frequente', sinossi: `Risposta dettagliata alla domanda più comune.` },
                        { titolo: `Costo ${capitalizeFirstLetter(s1)} a ${cittaC}`, keyword: `costo ${s1.toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Analisi Costi', sinossi: `Analisi trasparente dei costi.` },
                        s2 ? { titolo: `Focus su ${capitalizeFirstLetter(s2)} a ${cittaC}`, keyword: `${s2.toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Contenuto di Supporto', sinossi: `Approfondimento sul secondo servizio.` } : { titolo: `Bonus Edilizi a ${cittaC}`, keyword: `bonus edilizi ${citta.toLowerCase()}`, tipo: 'Contenuto di Supporto', sinossi: `Guida aggiornata sui bonus.` },
                    ]
                };
                
                wizardDiv.classList.add('hidden'); mindMapDiv.classList.remove('hidden'); detailedPlanDiv.classList.add('hidden');
                renderMindMap();

            } catch (error) {
                showModal('Ooops!', friendlyErrorMessage, false);
            } finally {
                generateMapBtn.innerHTML = `Crea Mappa Mentale`; generateMapBtn.disabled = false;
            }
        });

        mindMapContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.action) return;
            const { action, type, index } = button.dataset;

            if (action === 'delete') {
                if (type === 'pillar') { showModal('Attenzione!', 'Il contenuto Pillar non può essere eliminato.'); return; }
                mindMapData[type].splice(index, 1);
                renderMindMap();
            } else if (action === 'expand-ai') {
                button.innerHTML = `<div class="loader"></div>`; button.disabled = true;

                const { professione, servizi, citta } = userProfile;
                const existingTitles = [mindMapData.landing.titolo, mindMapData.pillar.titolo, ...mindMapData.clusters.map(c => c.titolo)].join(', ');
                const prompt = `Sei un esperto di content strategy per il settore edile in Italia. Profilo: ${professione} a ${citta}, specializzato in ${servizi.join(', ')}. Contenuti già in piano: ${existingTitles}. Suggerisci 3 nuove idee per articoli cluster. Per ogni idea, fornisci: "titolo", "keyword", "tipo" (es: 'Caso Studio', 'Confronto', 'Guida Pratica'), e "sinossi" di 20-30 parole. Rispondi solo con un array JSON valido.`;

                try {
                    const response = await fetch(`/.netlify/functions/generate-content-plan`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt }) });
                    if (!response.ok) throw new Error();
                    const newClusters = await response.json();
                    newClusters.forEach(cluster => { mindMapData.clusters.push({ ...cluster, tipo: 'Suggerito da AI' }); });
                    renderMindMap();
                } catch (error) {
                    showModal('Ooops!', friendlyErrorMessage, false);
                    button.innerHTML = '✨ Amplia con AI'; button.disabled = false;
                }
            }
        });

        mindMapContainer.addEventListener('focusout', (e) => { const p = e.target; if (p.dataset.action === 'edit-title') { const { type, index } = p.dataset; const newTitle = p.textContent.trim(); (type === 'clusters' ? mindMapData.clusters[index] : mindMapData[type]).titolo = newTitle; } });

        generateCalendarBtn.addEventListener('click', () => {
            planTableBody.innerHTML = '';
            allContentForCalendar = [mindMapData.landing, mindMapData.pillar, ...mindMapData.clusters];
            allContentForCalendar.forEach((item, index) => {
                const row = document.createElement('tr'); row.dataset.index = index;
                row.innerHTML = `<td class="px-6 py-4 text-sm font-medium">${index + 1}</td><td class="px-6 py-4 text-sm text-gray-800">${item.titolo}</td><td class="px-6 py-4 text-sm text-gray-500"><code>${item.keyword}</code></td><td class="px-6 py-4 text-center"><button data-action="write-ai" class="bg-purple-100 text-purple-800 text-xs font-bold py-1 px-2 rounded-full hover:bg-purple-200">✍️ Scrivi con AI</button></td>`;
                planTableBody.appendChild(row);
            });
            detailedPlanDiv.classList.remove('hidden');
            detailedPlanDiv.scrollIntoView();
        });
        
        planTableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || button.dataset.action !== 'write-ai') return;
            
            const row = button.closest('tr');
            const index = parseInt(row.dataset.index, 10);
            const contentItem = allContentForCalendar[index];

            button.innerHTML = `<div class="loader"></div>`; button.disabled = true;

            const prompt = `Sei un copywriter SEO esperto nel settore edile in Italia. Scrivi un articolo completo e ottimizzato per un blog, basato sui seguenti dati:
- Titolo (H1): "${contentItem.titolo}"
- Keyword principale: "${contentItem.keyword}"
- Concept: "${contentItem.sinossi}"
Requisiti: Linguaggio professionale ma accessibile. Struttura con introduzione, corpo (con sottotitoli H2/H3) e conclusione con call-to-action. Inserisci la keyword in modo naturale. Lunghezza circa 500-700 parole. Fornisci solo il contenuto dell'articolo come una singola stringa HTML (usando tag <p>, <h2>, <h3>, <ul>, <li>).`;

            try {
                const response = await fetch(`/.netlify/functions/generate-article`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt }) });
                if (!response.ok) throw new Error('Errore generazione articolo.');
                const { article } = await response.json();
                
                articleModalTitle.textContent = contentItem.titolo;
                articleModalContent.innerHTML = article;
                articleModal.classList.remove('hidden');
            } catch (error) {
                showModal('Ooops!', friendlyErrorMessage, false);
            } finally {
                button.innerHTML = '✍️ Scrivi con AI'; button.disabled = false;
            }
        });

        copyArticleBtn.addEventListener('click', () => {
            const textToCopy = articleModalContent.innerHTML;
            navigator.clipboard.writeText(textToCopy).then(() => {
                copyArticleBtn.textContent = 'Copiato!';
                setTimeout(() => { copyArticleBtn.textContent = 'Copia Articolo'; }, 2000);
            });
        });

        resetBtn.addEventListener('click', () => { wizardDiv.classList.remove('hidden'); mindMapDiv.classList.add('hidden'); detailedPlanDiv.classList.add('hidden'); wizardDiv.scrollIntoView(); });
        closeModalBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
        closeArticleModalBtn.addEventListener('click', () => articleModal.classList.add('hidden'));
    });
    </script>
</body>
</html>
