<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore di Calendario SEO con AI Strategica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .gradient-bg { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .plan-enter, .mindmap-enter { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .service-checkbox:checked + label { border-color: #3b82f6; background-color: #eff6ff; color: #1e40af; font-weight: 600; }
        .service-checkbox:disabled + label { cursor: not-allowed; background-color: #f3f4f6; border-color: #e5e7eb; color: #9ca3af; }
        [contenteditable]:focus { outline: 2px solid #3b82f6; background-color: #eff6ff; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="gradient-bg min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8 pt-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Generatore di Calendario Editoriale SEO</h1>
        </header>
        
        <div id="intro" class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl shadow-lg mb-10 text-center">
            <h2 class="text-xl font-bold text-gray-700 mb-2">Trova i clienti prima che loro trovino te.</h2>
            <p class="text-gray-600">Questo strumento ti aiuta a pianificare i contenuti per il tuo sito. Rispondi, personalizza la mappa e usa l'AI per scoprire nuove idee strategiche.</p>
        </div>

        <!-- FASE 1: WIZARD / INPUT -->
        <div id="wizard" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">1. Raccontaci di te</h2>
            <div class="space-y-6">
                <div>
                    <label for="professione" class="block text-sm font-medium text-gray-600 mb-2">Chi sei?</label>
                    <select id="professione" class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="">Seleziona...</option>
                        <option value="Architetto">Architetto</option>
                        <option value="Studio di Architettura">Studio di Architettura</option>
                        <option value="Interior Designer">Interior Designer</option>
                        <option value="Impresa Edile">Impresa Edile</option>
                        <option value="Geometra">Geometra</option>
                        <option value="altro">Altro (specifica)</option>
                    </select>
                    <input type="text" id="professione-altro" class="hidden mt-2 w-full p-3 border" placeholder="Specifica la tua professione">
                </div>
                <div>
                    <label for="citta" class="block text-sm font-medium text-gray-600 mb-2">Dove operi?</label>
                    <input type="text" id="citta" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Es: Firenze">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Servizi principali (max 3)</label>
                    <div id="services-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                </div>
                <div>
                    <label for="domanda_frequente" class="block text-sm font-medium text-gray-600 mb-2">Domanda frequente dei clienti</label>
                    <input type="text" id="domanda_frequente" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Es: Quanto costa ristrutturare casa">
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="generateMapBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700">
                    Crea Mappa Mentale
                </button>
            </div>
        </div>
        
        <!-- FASE 2: MAPPA MENTALE EDITABILE -->
        <div id="mindMap" class="hidden mt-12 mindmap-enter">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">2. Personalizza la tua Mappa Strategica</h2>
            <p class="text-gray-600 mb-6 text-center">Clicca sul testo per modificarlo. Usa l'AI per trovare nuove idee.</p>
            <div id="mindMapContainer" class="p-4 md:p-6 bg-white/70 rounded-2xl shadow-lg"></div>
            <div class="text-center mt-8 space-y-4 md:space-y-0 md:space-x-4">
                <button id="generateCalendarBtn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">
                    Genera Calendario Finale
                </button>
                 <button id="resetBtn" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600">
                    Ricomincia
                </button>
            </div>
        </div>

        <!-- FASE 3: PIANO DETTAGLIATO (TABELLA) -->
        <div id="detailedPlan" class="hidden mt-12 plan-enter">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">3. Il Tuo Piano Editoriale</h2>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Settimana</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Idea di Titolo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keyword Suggerita</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sinossi</th>
                        </tr>
                    </thead>
                    <tbody id="planTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modale per messaggi di errore -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Attenzione!</h3>
            <p id="errorMessage" class="text-gray-700 mb-6"></p>
            <button id="closeModalBtn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600">Ho capito</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const wizardDiv = document.getElementById('wizard');
        const generateMapBtn = document.getElementById('generateMapBtn');
        const mindMapDiv = document.getElementById('mindMap');
        const mindMapContainer = document.getElementById('mindMapContainer');
        const generateCalendarBtn = document.getElementById('generateCalendarBtn');
        const detailedPlanDiv = document.getElementById('detailedPlan');
        const planTableBody = document.getElementById('planTableBody');
        const resetBtn = document.getElementById('resetBtn');
        const professioneSelect = document.getElementById('professione');
        const professioneAltroInput = document.getElementById('professione-altro');
        const servicesContainer = document.getElementById('services-container');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');

        let mindMapData = {};
        let userProfile = {};

        const allServices = ['Ristrutturazione appartamenti', 'Ristrutturazione casa', 'Ristrutturazione negozio', 'Ristrutturazione ristorante', 'Ristrutturazione hotel', 'Costruzione villa', 'Pratiche edilizie', 'Calcolo strutturale', 'Abuso edilizio', 'Sanatoria Edilizia'];
        allServices.forEach(service => {
            const div = document.createElement('div');
            const id = `service-${service.toLowerCase().replace(/\s+/g, '-')}`;
            div.innerHTML = `<input type="checkbox" id="${id}" name="servizio" value="${service}" class="hidden service-checkbox"><label for="${id}" class="block text-center text-sm p-3 border rounded-lg cursor-pointer">${service}</label>`;
            servicesContainer.appendChild(div);
        });

        const capitalizeFirstLetter = (string) => string ? string.charAt(0).toUpperCase() + string.slice(1) : '';
        const toggleModal = (show, message = "Compila tutti i campi.") => {
            errorMessage.textContent = message;
            errorModal.classList.toggle('hidden', !show);
        };

        function renderMindMap() {
            mindMapContainer.innerHTML = '';
            const { landing, pillar, clusters } = mindMapData;
            let mapHtml = `<div class="flex flex-col items-center space-y-4">`;
            mapHtml += createNodeHtml('landing', 0, landing);
            mapHtml += `<div class="h-8 w-px bg-gray-400"></div>`;
            mapHtml += createNodeHtml('pillar', 0, pillar);
            if (clusters.length > 0) {
                mapHtml += `<div class="h-8 w-px bg-gray-400"></div><div class="flex flex-wrap justify-center gap-4" id="cluster-container">`;
                clusters.forEach((cluster, index) => mapHtml += createNodeHtml('clusters', index, cluster, true));
                mapHtml += `</div>`;
            }
            mapHtml += `<div class="mt-6"><button data-action="expand-ai" class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 py-2 px-4 rounded-full font-semibold flex items-center gap-2">✨ Amplia con AI</button></div></div>`;
            mindMapContainer.innerHTML = mapHtml;
        }

        function createNodeHtml(type, index, data, isCluster = false) {
            let bgColor = data.tipo === 'Suggerito da AI' ? 'bg-purple-50' : (isCluster ? 'bg-green-50' : (type === 'landing' ? 'bg-red-50' : (type === 'pillar' ? 'bg-blue-50' : 'bg-white')));
            return `<div class="p-4 rounded-lg shadow-md ${bgColor} w-full md:w-auto md:max-w-md text-center">
                <div class="flex items-center justify-center">
                    <p contenteditable="true" data-action="edit-title" data-type="${type}" data-index="${index}" class="font-bold text-gray-800 p-1">${data.titolo}</p>
                    ${type !== 'landing' ? `<button data-action="delete" data-type="${type}" data-index="${index}" class="ml-2 text-red-400 hover:text-red-600 text-xl font-bold">&times;</button>` : ''}
                </div>
                <p class="text-xs text-gray-500 mt-1"><code>${data.keyword}</code></p>
            </div>`;
        }
        
        generateMapBtn.addEventListener('click', () => {
            const professione = professioneSelect.value === 'altro' ? professioneAltroInput.value.trim() : professioneSelect.value;
            const servizi = Array.from(servicesContainer.querySelectorAll('input[name="servizio"]:checked')).map(cb => cb.value);
            const citta = document.getElementById('citta').value.trim();
            const domanda_frequente = document.getElementById('domanda_frequente').value.trim();

            if (!professione || !citta || servizi.length === 0 || !domanda_frequente) {
                toggleModal(true, "Assicurati di compilare tutti i campi.");
                return;
            }
            
            userProfile = { professione, servizi, citta };

            const cittaC = capitalizeFirstLetter(citta);
            const s1 = servizi[0];
            const domanda = domanda_frequente.replace(/\?$/, '');

            mindMapData = {
                landing: { titolo: `${capitalizeFirstLetter(professione)} a ${cittaC}`, keyword: `${professione.toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Landing Page Locale', sinossi: `Pagina di vendita principale. Descrivi chi sei, i tuoi servizi con focus su "${s1}", mostra un portfolio e testimonianze. L'obiettivo è convertire: inserisci una CTA chiara come 'Richiedi un Preventivo Gratuito'.` },
                pillar: { titolo: `Guida a ${capitalizeFirstLetter(s1)} a ${cittaC}`, keyword: `guida ${s1.toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Contenuto Pillar', sinossi: `Articolo principale e più completo. Strutturalo in capitoli: fasi del progetto, permessi a ${cittaC}, stima dei costi, scelta materiali e bonus fiscali. Usa immagini, checklist e linka ai tuoi contenuti di supporto.` },
                clusters: [
                    { titolo: `${capitalizeFirstLetter(domanda)} a ${cittaC}?`, keyword: `${domanda.toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Domanda Frequente', sinossi: `Rispondi in modo esaustivo, chiaro e diretto. Usa il primo paragrafo per dare la risposta breve, poi approfondisci. Dimostra di capire le loro preoccupazioni.` },
                    { titolo: `Costo ${capitalizeFirstLetter(s1)} a ${cittaC}`, keyword: `costo ${s1.toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Analisi Costi', sinossi: `Sii trasparente. Analizza le voci di costo per "${s1}" a ${cittaC}. Fornisci range di prezzo (es. al mq) e spiega i fattori che influenzano il costo. Questo genera enorme fiducia.` },
                    servizi[1] ? { titolo: `Focus su ${capitalizeFirstLetter(servizi[1])} a ${cittaC}`, keyword: `${servizi[1].toLowerCase()} ${citta.toLowerCase()}`, tipo: 'Contenuto di Supporto', sinossi: `Crea un articolo di approfondimento per questo servizio. Offri consigli pratici, spiega i benefici e mostra la tua esperienza specifica nel campo.` } : { titolo: `Bonus Edilizi a ${cittaC}`, keyword: `bonus edilizi ${citta.toLowerCase()}`, tipo: 'Contenuto di Supporto', sinossi: `Articolo sempre aggiornato sui bonus fiscali disponibili per i lavori edili a ${cittaC}. Spiega chi può richiederli e come fare.` },
                ]
            };
            
            wizardDiv.classList.add('hidden');
            mindMapDiv.classList.remove('hidden');
            detailedPlanDiv.classList.add('hidden');
            renderMindMap();
        });

        mindMapContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.action) return;
            const { action, type, index } = button.dataset;

            if (action === 'delete') {
                if (type === 'pillar') { toggleModal(true, "Il Pillar non può essere eliminato."); return; }
                mindMapData[type].splice(index, 1);
                renderMindMap();
            } else if (action === 'expand-ai') {
                button.innerHTML = `<div class="loader"></div>`;
                button.disabled = true;

                const { professione, servizi, citta } = userProfile;
                const existingTitles = [mindMapData.landing.titolo, mindMapData.pillar.titolo, ...mindMapData.clusters.map(c => c.titolo)].join(', ');
                const prompt = `Sei un esperto di content strategy per il settore edile in Italia. Il tuo obiettivo è suggerire idee per articoli di blog (cluster) che aiutino un professionista a trovare clienti.
Profilo: ${professione} che opera a ${citta} e offre principalmente i seguenti servizi: ${servizi.join(', ')}.
Contenuti già in piano: ${existingTitles}.
Basandoti sul profilo e sui contenuti esistenti, suggerisci 3 nuove idee per articoli di blog. Le idee devono essere pertinenti e utili per chi cerca questi servizi a ${citta}.
Per ogni idea, fornisci: "titolo", "keyword", "tipo" (es: 'Caso Studio', 'Confronto', 'Guida Pratica', 'Errore da Evitare'), e una "sinossi" di 20-30 parole.
Fornisci la risposta solo come un array JSON valido, senza testo o spiegazioni aggiuntive. Ad esempio: [{"titolo": "...", "keyword": "...", "tipo": "...", "sinossi": "..."}]`;

                try {
                    const response = await fetch(`/.netlify/functions/generate-content-plan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Errore API`);
                    }
                    const newClusters = await response.json();
                    
                    newClusters.forEach(cluster => {
                        mindMapData.clusters.push({ ...cluster, titolo: `${cluster.titolo}`, tipo: 'Suggerito da AI' });
                    });
                    renderMindMap();

                } catch (error) {
                    toggleModal(true, `Errore AI: ${error.message}`);
                    button.innerHTML = '✨ Amplia con AI';
                    button.disabled = false;
                }
            }
        });

        mindMapContainer.addEventListener('focusout', (e) => {
            const p = e.target;
            if (p.dataset.action === 'edit-title') {
                const { type, index } = p.dataset;
                const newTitle = p.textContent.trim();
                (type === 'clusters' ? mindMapData.clusters[index] : mindMapData[type]).titolo = newTitle;
            }
        });

        generateCalendarBtn.addEventListener('click', () => {
            planTableBody.innerHTML = '';
            const allContent = [mindMapData.landing, mindMapData.pillar, ...mindMapData.clusters];
            
            allContent.forEach((item, index) => {
                const row = document.createElement('tr');
                const tipoClass = item.tipo === 'Landing Page Locale' ? 'bg-red-100 text-red-800' : (item.tipo === 'Contenuto Pillar' ? 'bg-blue-100 text-blue-800' : (item.tipo === 'Suggerito da AI' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'));
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium">${index + 1}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${item.titolo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500"><code>${item.keyword}</code></td>
                    <td class="px-6 py-4 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tipoClass}">${item.tipo}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-600" style="min-width: 300px;">${item.sinossi || ''}</td>
                `;
                planTableBody.appendChild(row);
            });
            detailedPlanDiv.classList.remove('hidden');
            detailedPlanDiv.scrollIntoView();
        });
        
        resetBtn.addEventListener('click', () => {
            wizardDiv.classList.remove('hidden');
            mindMapDiv.classList.add('hidden');
            detailedPlanDiv.classList.add('hidden');
            wizardDiv.scrollIntoView();
        });
        closeModalBtn.addEventListener('click', () => toggleModal(false));
        servicesContainer.addEventListener('change', (e) => {
            if (e.target.name === 'servizio') {
                const checked = servicesContainer.querySelectorAll('input[name="servizio"]:checked');
                const disabled = checked.length >= 3;
                servicesContainer.querySelectorAll('input[name="servizio"]:not(:checked)').forEach(cb => cb.disabled = disabled);
            }
        });
        professioneSelect.addEventListener('change', () => {
            professioneAltroInput.classList.toggle('hidden', professioneSelect.value !== 'altro');
        });
    });
    </script>
</body>
</html>
